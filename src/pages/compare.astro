---
import '../styles/toast.css';
---

<html lang="en" id="html-root">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>Compare Simulations - Mortgage Amortization Calculator</title>
		<meta name="description" content="Compare and analyze your saved mortgage simulations" />
	</head>
	<body class="bg-gray-50 min-h-screen">
		<!-- Collapsible Sidebar Menu -->
		<div id="sidebar" class="fixed left-0 top-0 h-full bg-white shadow-lg z-50 transition-all duration-300 ease-in-out" style="width: 60px;">
			<div class="flex flex-col h-full">
				<!-- Toggle Button -->
				<button id="sidebar-toggle" class="p-3 text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition-colors">
					<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
					</svg>
				</button>
				
				<!-- Menu Items -->
				<nav class="flex-1 flex flex-col py-2">
					<!-- Home -->
					<a href="/" class="sidebar-item group" title="Home">
						<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
						</svg>
						<span class="sidebar-text">Home</span>
					</a>
					
					<!-- Compare Simulations -->
					<button id="compare-simulations-btn" class="sidebar-item group" title="Compare Simulations">
						<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
						</svg>
						<span class="sidebar-text">Compare</span>
					</button>
					
					<!-- Language -->
					<button id="language-menu-btn" class="sidebar-item group" title="Change Language">
						<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
						</svg>
						<span class="sidebar-text">Language</span>
					</button>
				</nav>
			</div>
		</div>
		
		<!-- Main Content Area -->
		<div id="main-content" class="transition-all duration-300 ease-in-out" style="margin-left: 60px;">
			<main class="container mx-auto px-4 py-4">
				<header class="text-left mb-4 h-16 flex items-end justify-between w-full" id="main-header">
					<div class="flex flex-col sm:flex-row sm:items-end gap-1 sm:gap-2">
						<h1 class="text-2xl font-bold text-gray-900" data-i18n="compare.title">Compare Simulations</h1>
						<p class="text-sm text-gray-600" data-i18n="compare.description">Compare and analyze your saved mortgage simulations</p>
					</div>
				</header>
			
				<!-- Simulations Table -->
				<div class="bg-white rounded-lg shadow-lg p-6 mb-6">
					<h2 class="text-lg font-semibold text-gray-800 mb-4" data-i18n="compare.simulationsList">Saved Simulations</h2>
					<div class="overflow-x-auto">
						<table class="w-full">
							<colgroup>
								<col class="w-1/3">
								<col class="w-1/6">
								<col class="w-1/6">
								<col class="w-1/6">
								<col class="w-1/6">
							</colgroup>
							<thead>
								<tr class="border-b border-gray-200">
									<th class="text-left py-3 px-4 font-medium text-gray-700">Name</th>
									<th class="text-right py-3 px-4 font-medium text-gray-700">Loan Amount</th>
									<th class="text-right py-3 px-4 font-medium text-gray-700">Loan Term</th>
									<th class="text-right py-3 px-4 font-medium text-gray-700">Interest Rate</th>
									<th class="text-right py-3 px-4 font-medium text-gray-700">Total Payment Made</th>
								</tr>
							</thead>
							<tbody id="simulations-table-body">
								<!-- Simulations will be loaded here -->
							</tbody>
						</table>
					</div>
					<div id="no-simulations-message" class="text-center py-8 text-gray-500" style="display: none;">
						<svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
						</svg>
						<p data-i18n="compare.noSimulations">No saved simulations found</p>
						<a href="/" class="inline-block mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors" data-i18n="compare.createFirst">Create your first simulation</a>
					</div>
				</div>
			</main>
		</div>

		<!-- Language Modal -->
		<div id="language-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
			<div class="flex items-center justify-center min-h-screen p-4">
				<div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
					<h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="common.language">Language</h3>
					<div class="space-y-3">
						<button class="language-option w-full text-left px-4 py-2 rounded-md hover:bg-gray-100 transition-colors" data-lang="en">
							<span class="font-medium">English</span>
						</button>
						<button class="language-option w-full text-left px-4 py-2 rounded-md hover:bg-gray-100 transition-colors" data-lang="fr">
							<span class="font-medium">Français</span>
						</button>
						<button class="language-option w-full text-left px-4 py-2 rounded-md hover:bg-gray-100 transition-colors" data-lang="es">
							<span class="font-medium">Español</span>
						</button>
					</div>
					<div class="mt-6 flex justify-end">
						<button id="close-language-modal" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
							Close
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Toast Notification Container -->
		<div id="toast-container" class="fixed top-4 right-4 z-[60] space-y-2">
			<!-- Toast notifications will be dynamically added here -->
		</div>

		<style>
			/* Sidebar Styles */
			.sidebar-item {
				@apply flex items-center p-3 text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition-colors relative;
			}
			
			.sidebar-text {
				@apply ml-3 whitespace-nowrap opacity-0 transform translate-x-[-10px] transition-all duration-300 ease-in-out;
				position: absolute;
				left: 60px;
				background: white;
				padding: 8px 12px;
				border-radius: 6px;
				box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
				z-index: 10;
				white-space: nowrap;
			}
			
			.sidebar-item:hover .sidebar-text {
				@apply opacity-100 translate-x-0;
			}
			
			/* Expanded sidebar styles */
			#sidebar.expanded {
				width: 250px !important;
			}
			
			#sidebar.expanded .sidebar-text {
				@apply opacity-100 translate-x-0 relative left-0 bg-transparent shadow-none p-0;
			}
			
			#main-content.expanded {
				margin-left: 250px !important;
			}
			
			/* Language modal styles */
			.language-option.active {
				@apply bg-blue-100 text-blue-900;
			}
			
			/* Table styles */
			.simulation-row {
				@apply transition-colors;
			}
			
			.simulation-row:hover {
				@apply bg-gray-50;
			}
			
			.simulation-details-row {
				@apply transition-all duration-200;
			}
			
			.expand-btn svg {
				@apply transition-transform duration-200;
			}
			
			.expand-btn:hover svg {
				@apply text-gray-600;
			}
			
			/* Responsive table */
			@media (max-width: 768px) {
				table {
					@apply text-sm;
				}
				
				th, td {
					@apply px-2 py-2;
				}
			}
		</style>

		<script src="/i18n/index.js" is:inline></script>
		<script>
			// Wait for i18n system to be ready before initializing
			document.addEventListener('DOMContentLoaded', async function() {
				// Wait for i18n system to be ready
				if (window.i18n && window.i18n.waitForReady) {
					await window.i18n.waitForReady();
				}
				
				// Initialize the page functionality
				initializePage();
			});
			
		// Toast notification system
		function showToast(message: string, type: 'info' | 'success' | 'error' | 'warning' = 'info', duration: number = 4000) {
				const container = document.getElementById('toast-container');
				const toast = document.createElement('div');
				const toastId = 'toast-' + Date.now();
				
				// Set up toast classes
				toast.className = `toast ${type}`;
				toast.id = toastId;
				
				// Get icon based on type
				let iconSvg = '';
				switch(type) {
					case 'success':
						iconSvg = '<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
						break;
					case 'error':
						iconSvg = '<svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
						break;
					case 'warning':
						iconSvg = '<svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>';
						break;
					default:
						iconSvg = '<svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
				}
				
				// Create toast content
				toast.innerHTML = `
					<div class="toast-content">
						<div class="toast-icon">
							${iconSvg}
						</div>
						<div class="toast-message">${message}</div>
						<button class="toast-close" onclick="hideToast('${toastId}')">
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
							</svg>
						</button>
					</div>
				`;
				
		// Add to container
		if (container) container.appendChild(toast);
				
				// Trigger animation
				setTimeout(() => {
					toast.classList.add('show');
				}, 10);
				
				// Auto-hide after duration
				if (duration > 0) {
					setTimeout(() => {
						hideToast(toastId);
					}, duration);
				}
			}
			
			function hideToast(toastId: string) {
				const toast = document.getElementById(toastId);
				if (toast) {
					toast.classList.remove('show');
					toast.classList.add('hide');
					setTimeout(() => {
						toast.remove();
					}, 300);
				}
			}
			
			// Make functions globally accessible
			window.hideToast = hideToast;
			window.showToast = showToast;
			
			// Function to get saved simulations
			function getSavedSimulations() {
				const stored = localStorage.getItem('mortgage-calculator-simulations');
				return stored ? JSON.parse(stored) : [];
			}
			
		// Function to calculate total payment made for a simulation
		function calculateTotalPaymentMade(simulation: any) {
			// Handle both old and new format
			const isNewFormat = simulation.mortgageSimulation;
			
			let loanAmount, interestRate, loanTerm, servicePayments;
			
			if (isNewFormat) {
				// New format - mortgage simulation with nested structure
				loanAmount = simulation.mortgageSimulation?.loanAmount || 0;
				interestRate = simulation.mortgageSimulation?.interestRate || 0;
				loanTerm = simulation.mortgageSimulation?.loanTerm || 0;
				servicePayments = simulation.mortgageSimulation?.servicePayments || [];
			} else {
				// Old format - direct properties
				loanAmount = simulation.loanAmount || 0;
				interestRate = simulation.interestRate || 0;
				loanTerm = simulation.loanTerm || 0;
				servicePayments = simulation.servicePayments || [];
			}
			
			// Calculate monthly payment using French amortization formula
			const monthlyRate = Number(interestRate) / 100 / 12;
			const totalPayments = Number(loanTerm) * 12;
			const monthlyPayment = Number(loanAmount) * (monthlyRate * Math.pow(1 + monthlyRate, totalPayments)) / (Math.pow(1 + monthlyRate, totalPayments) - 1);
			
			// Calculate total service payments
			const monthlyServicePayments = (servicePayments || []).reduce((sum: number, service: any) => sum + (Number(service?.monthlyCost) || 0), 0);
			
			// Total payment made = (monthly payment + service payments) * number of payments
			const totalPaymentMade = (monthlyPayment + monthlyServicePayments) * totalPayments;
			
			return totalPaymentMade;
		}

		// Function to create simulation table row
		function createSimulationRow(simulation: any) {
			const savedDate = simulation.savedAt ? new Date(simulation.savedAt).toLocaleDateString() : 'Unknown date';
			
			// Handle both old and new format
			const isNewFormat = simulation.mortgageSimulation;
			
			let loanAmount, interestRate, loanTerm, servicePayments;
			
			if (isNewFormat) {
				// New format - mortgage simulation with nested structure
				loanAmount = simulation.mortgageSimulation?.loanAmount || 0;
				interestRate = simulation.mortgageSimulation?.interestRate || 0;
				loanTerm = simulation.mortgageSimulation?.loanTerm || 0;
				servicePayments = simulation.mortgageSimulation?.servicePayments || [];
			} else {
				// Old format - direct properties
				loanAmount = simulation.loanAmount || 0;
				interestRate = simulation.interestRate || 0;
				loanTerm = simulation.loanTerm || 0;
				servicePayments = simulation.servicePayments || [];
			}
			
			const totalPaymentMade = calculateTotalPaymentMade(simulation);
			const serviceCount = servicePayments.length;
			const monthlyServiceTotal = (servicePayments || []).reduce((sum: number, service: any) => sum + (Number(service?.monthlyCost) || 0), 0);
			
			return `
				<tr class="simulation-row border-b border-gray-100 hover:bg-gray-50 transition-colors cursor-pointer" data-name="${simulation.name}">
					<td class="py-4 px-4">
						<div class="flex items-center">
							<button class="expand-btn mr-3 text-gray-400 hover:text-gray-600 transition-colors flex-shrink-0" data-name="${simulation.name}">
								<svg class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
								</svg>
							</button>
							<div class="min-w-0 flex-1">
								<div class="font-medium text-gray-900 truncate">${simulation.name}</div>
							</div>
						</div>
					</td>
					<td class="py-4 px-4 text-right font-medium text-gray-900">€${Number(loanAmount).toLocaleString()}</td>
					<td class="py-4 px-4 text-right text-gray-700">${Number(loanTerm)} years</td>
					<td class="py-4 px-4 text-right text-gray-700">${Number(interestRate).toFixed(2)}%</td>
					<td class="py-4 px-4 text-right font-semibold text-blue-700">€${totalPaymentMade.toLocaleString()}</td>
				</tr>
				<tr class="simulation-details-row hidden" data-name="${simulation.name}">
					<td colspan="5" class="py-4 px-4 bg-gray-50">
						<div class="space-y-4">
							<!-- Service Payments Details -->
							<div>
								<h4 class="font-medium text-gray-700 text-sm mb-3">Service Payments</h4>
								${serviceCount > 0 ? `
									<div class="space-y-2">
										<div class="flex justify-between text-sm">
											<span class="text-gray-600">Count:</span>
											<span class="font-medium">${serviceCount}</span>
										</div>
										<div class="flex justify-between text-sm">
											<span class="text-gray-600">Monthly Total:</span>
											<span class="font-medium text-blue-700">€${monthlyServiceTotal.toFixed(2)}</span>
										</div>
										<div class="mt-3">
											<div class="text-xs text-gray-500 mb-2">Service Details:</div>
											${servicePayments.map((service: any) => `
												<div class="flex justify-between text-xs py-1 border-b border-gray-200 last:border-b-0">
													<span class="text-gray-600">${service.name || 'Unnamed Service'}</span>
													<span class="font-medium">€${Number(service.monthlyCost || 0).toFixed(2)}</span>
												</div>
											`).join('')}
										</div>
									</div>
								` : '<div class="text-sm text-gray-500">No service payments</div>'}
							</div>
							
							<!-- Load Link -->
							<div class="flex justify-start">
								<a href="/?load=${encodeURIComponent(simulation.name)}" class="load-simulation-link text-blue-600 hover:text-blue-800 hover:underline text-sm font-medium">
									Load Simulation
								</a>
							</div>
						</div>
					</td>
				</tr>
			`;
		}
			
		// Function to load simulations
		function loadSimulations() {
			const simulations = getSavedSimulations();
			const container = document.getElementById('simulations-table-body');
			const noSimulationsMessage = document.getElementById('no-simulations-message');
			
			if (!container || !noSimulationsMessage) return;
			
			if (simulations.length === 0) {
				container.style.display = 'none';
				noSimulationsMessage.style.display = 'block';
				return;
			}
			
			container.style.display = '';
			noSimulationsMessage.style.display = 'none';
			
			container.innerHTML = simulations.map((simulation: any) => createSimulationRow(simulation)).join('');
				
			// Add event listeners for expand/collapse
			container.querySelectorAll('.expand-btn').forEach(btn => {
				btn.addEventListener('click', function(this: HTMLElement, e: Event) {
					e.stopPropagation();
					const simulationName = this.dataset.name;
					toggleSimulationDetails(simulationName || '');
				});
			});
			
			// Load links are now direct href links, no event listeners needed
		}
		
		// Function to toggle simulation details
		function toggleSimulationDetails(simulationName: string) {
			const detailsRow = document.querySelector(`.simulation-details-row[data-name="${simulationName}"]`);
			const expandBtn = document.querySelector(`.expand-btn[data-name="${simulationName}"] svg`);
			
			if (detailsRow && expandBtn) {
				const isHidden = detailsRow.classList.contains('hidden');
				
				if (isHidden) {
					detailsRow.classList.remove('hidden');
					expandBtn.classList.add('rotate-90');
				} else {
					detailsRow.classList.add('hidden');
					expandBtn.classList.remove('rotate-90');
				}
			}
		}
			
		// Function to delete simulation
		function deleteSimulation(simulationName: string) {
			const simulations = getSavedSimulations();
			const filteredSimulations = simulations.filter((s: any) => s.name !== simulationName);
				
				localStorage.setItem('mortgage-calculator-simulations', JSON.stringify(filteredSimulations));
				loadSimulations();
				
				showToast(`Simulation "${simulationName}" deleted successfully`, 'success');
			}
			
		// Initialize page functionality
		function initializePage() {
			const sidebar = document.getElementById('sidebar');
			const mainContent = document.getElementById('main-content');
			const toggleBtn = document.getElementById('sidebar-toggle');
			const languageModal = document.getElementById('language-modal');
			
			// Toggle sidebar
			if (toggleBtn) {
				toggleBtn.addEventListener('click', function() {
					if (sidebar) sidebar.classList.toggle('expanded');
					if (mainContent) mainContent.classList.toggle('expanded');
				});
			}
				
			// Language menu
			const languageMenuBtn = document.getElementById('language-menu-btn');
			if (languageMenuBtn) {
				languageMenuBtn.addEventListener('click', function() {
					// Re-setup language options in case they weren't found initially
					setupLanguageOptions();
					
					// Update active language in modal
					const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'en';
					
					document.querySelectorAll('.language-option').forEach(option => {
						option.classList.remove('active');
						if ((option as HTMLElement).dataset.lang === currentLang) {
							option.classList.add('active');
						}
					});
					if (languageModal) languageModal.classList.remove('hidden');
				});
			}
				
			// Close modals
			const closeLanguageModalBtn = document.getElementById('close-language-modal');
			if (closeLanguageModalBtn) {
				closeLanguageModalBtn.addEventListener('click', function() {
					if (languageModal) languageModal.classList.add('hidden');
				});
			}
				
			// Language selection - set up event listeners when modal opens
			function setupLanguageOptions() {
				const languageOptions = document.querySelectorAll('.language-option');
				
				languageOptions.forEach((option) => {
					// Remove any existing click listeners to prevent duplicates
					option.replaceWith(option.cloneNode(true));
				});
				
				// Re-query after cloning to get fresh elements
				const freshLanguageOptions = document.querySelectorAll('.language-option');
				
				freshLanguageOptions.forEach((option) => {
					option.addEventListener('click', function(this: HTMLElement, e: Event) {
						const lang = this.dataset.lang;
						
						// Change language directly using i18n system
						if (window.i18n && lang) {
							window.i18n.changeLanguage(lang);
						}
						if (languageModal) languageModal.classList.add('hidden');
					});
				});
			}
				
			// Set up language options initially
			setupLanguageOptions();
			
			// Close modals on outside click
			if (languageModal) {
				languageModal.addEventListener('click', function(e: Event) {
					if (e.target === languageModal) {
						languageModal.classList.add('hidden');
					}
				});
			}
				
				// Load simulations on page load
				loadSimulations();
			}
		</script>
	</body>
</html>
